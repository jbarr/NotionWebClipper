/*! For license information please see service-worker.js.LICENSE.txt */
(()=>{var e={"./node_modules/@web-clipper/shared/lib/uuid/index.js":(e,a)=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.generateUuid=function(){return(new s).asHex()};var t,o=(t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var t in a)a.hasOwnProperty(t)&&(e[t]=a[t])},t(e,a)},function(e,a){function o(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(o.prototype=a.prototype,new o)}),s=function(e){function a(){return e.call(this,[a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),"-",a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),"-","4",a._randomHex(),a._randomHex(),a._randomHex(),"-",a._oneOf(a._timeHighBits),a._randomHex(),a._randomHex(),a._randomHex(),"-",a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex(),a._randomHex()].join(""))||this}return o(a,e),a._oneOf=function(e){return e[Math.floor(e.length*Math.random())]},a._randomHex=function(){return a._oneOf(a._chars)},a._chars=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],a._timeHighBits=["8","9","a","b"],a}(function(){function e(e){this._value=e,this._value=e}return e.prototype.asHex=function(){return this._value},e}())},"./src/service/save-fullpage-bookmark.js":e=>{e.exports=async(e,a)=>{try{const t=a.type,o=a.content;return"collection"===t&&(o.property="zZ:O"),await fetch("https://www.notion.so/api/v3/addWebClipperURLs",{method:"POST",headers:{Cookie:e,"Content-Type":"application/json"},body:JSON.stringify(o)}),{success:!0,message:"Page bookmark successfully"}}catch(e){return{success:!1,message:e.message}}}},"./src/service/save-image.js":(e,a,t)=>{const o="skynox",s="u1yjhapy",r=t("./src/service/save-url-section.js");e.exports=async(e,a)=>{try{const t=a.imageSrc,n=new FormData;n.append("file",t),n.append("upload_preset",s);const c=`https://api.cloudinary.com/v1_1/${o}/image/upload`,l=await fetch(c,{method:"POST",headers:{"Cache-Control":"no-cache"},body:n}),i=`<img src=${(await l.json()).secure_url}></img>`;return a.content=i,await r(e,a),{success:!0,message:"Image saved successfully"}}catch(e){return{success:!1,message:e.message}}}},"./src/service/save-url-section.js":(e,a,t)=>{const o=t("./node_modules/@web-clipper/shared/lib/uuid/index.js").generateUuid;e.exports=async(e,a)=>{try{const t=o(),s=a.parentId,r=a.userId,n=a.type,c=a.url,l=a.name,i=a.content,d=function(e,a,t,o,s){let r;return r="block"===e?[{id:a,table:"block",path:[],command:"set",args:{type:"page",id:a,version:1}},{id:a,table:"block",path:[],command:"update",args:{parent_id:t,parent_table:"block",alive:!0}},{table:"block",id:t,path:["content"],command:"listAfter",args:{id:a}},{id:a,table:"block",path:[],command:"update",args:{created_by:o,created_time:2,last_edited_time:2,last_edited_by:o}},{id:t,table:"block",path:[],command:"update",args:{last_edited_time:2}},{id:a,table:"block",path:["properties","title"],command:"set",args:[[`## Link\n\n [${s}](${s})`]]},{id:a,table:"block",path:[],command:"update",args:{last_edited_time:2}}]:[{id:a,table:"block",path:[],command:"set",args:{type:"page",id:a,version:1}},{id:a,table:"block",path:[],command:"update",args:{parent_id:t,parent_table:"collection",alive:!0}}],r}(n,t,s,r,c);await fetch("https://www.notion.so/api/v3/submitTransaction",{method:"POST",headers:{Cookie:e,"Content-Type":"application/json"},body:JSON.stringify({operations:d})});const u={bucket:"temporary",contentType:"text/markdown",name:`${l}.md`},m=await fetch("https://www.notion.so/api/v3/getUploadFileUrl",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e},body:JSON.stringify(u)}),p=await m.json(),g=await fetch("https://prototion.com/api/notion-web-clipper",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:i})}),{data:h}=await g.json();await fetch(p.signedPutUrl,{method:"PUT",headers:{"Content-Type":"text/markdown"},body:h});const _={task:{eventName:"importFile",request:{fileName:`${l}.md`,fileURL:p.url,importType:"ReplaceBlock",pageId:t}}};return await fetch("https://www.notion.so/api/v3/enqueueTask",{method:"POST",headers:{Cookie:e,"Content-Type":"application/json"},body:JSON.stringify(_)}),{success:!0,message:"Content uploaded successfully"}}catch(e){return{success:!1,message:e.message}}}}},a={};function t(o){var s=a[o];if(void 0!==s)return s.exports;var r=a[o]={exports:{}};return e[o](r,r.exports,t),r.exports}(()=>{try{const e=t("./src/service/save-url-section.js"),a=t("./src/service/save-fullpage-bookmark.js"),o=t("./src/service/save-image.js");chrome.runtime.onInstalled.addListener((()=>{chrome.cookies.getAll({url:"https://www.notion.so/"},(function(e){e.reduce(((e,a)=>({...e,[a.name]:a.value})),{}).token_v2?(chrome.tabs.create({url:"https://prototion.com/notion-pro-clipper/login?notion=true",active:!0}),chrome.storage.local.set({firstTimeLogin:!0})):chrome.tabs.create({url:"https://prototion.com/notion-pro-clipper/login?notion=false",active:!0})})),chrome.storage.local.set({databases:[],pages:[],userId:null,userEmail:null,userImage:null,userName:null,toggleSaveImage:!0,firstTimeLogin:!1,selectedDB:null,spaceId:null}),chrome.contextMenus.create({id:"notionprototion",title:"Save to Notion",type:"normal",contexts:["image"]})}));const s={myTabId:0,myTabUrl:"",myTabStatus:"",userId:null,userEmail:null,userImage:null,userName:null,cookies:null,databases:[],pages:[],spaceId:null};chrome.tabs.onUpdated.addListener(((e,a,t)=>{s.myTabId=e,s.myTabUrl=t.url,s.myTabStatus=a.status,chrome.storage.local.get("firstTimeLogin",(a=>{a.firstTimeLogin||chrome.cookies.getAll({url:"https://www.notion.so/"},(function(a){a.reduce(((e,a)=>({...e,[a.name]:a.value})),{}).token_v2&&(chrome.storage.local.set({firstTimeLogin:!0}),chrome.tabs.sendMessage(e,{message:"notion_logged_in"}))}))}))})),chrome.runtime.onMessage.addListener(((t,r,n)=>("coords"==t.type?chrome.tabs.captureVisibleTab(null,{format:"png"},(function(e){n({imgSrc:e})})):"load_user"===t.message?chrome.cookies.getAll({url:"https://www.notion.so/"},(function(e){const a=e.reduce(((e,a)=>({...e,[a.name]:a.value})),{});if(a.token_v2){let e="";for(const t in a)e+=`${t}=${a[t]}; `;s.cookies=e,function(e){fetch("https://www.notion.so/api/v3/loadUserContent",{method:"POST",headers:{Cookie:e}}).then((e=>e.json())).then((e=>{s.userId=Object.keys(e.recordMap.notion_user)[0],s.userEmail=e.recordMap.notion_user[s.userId].value.email,s.userName=`${e.recordMap.notion_user[s.userId].value.given_name} ${e.recordMap.notion_user[s.userId].value.family_name}`,e.recordMap.notion_user[s.userId].value.profile_photo&&(s.userImage=e.recordMap.notion_user[s.userId].value.profile_photo),function(e){const a=[],t=[];for(const t in e.recordMap.collection){const o=e.recordMap.collection[t].value?.name[0][0],r=e.recordMap.collection[t].value?.id,n=e.recordMap.collection[t].value?.parent_id,c=e.recordMap.collection[t].value?.icon||null;chrome.storage.local.set({spaceId:e.recordMap.collection[t].value?.space_id}),s.spaceId=e.recordMap.collection[t].value?.space_id,n&&o&&r&&a.push({id:r,name:o,type:"collection",parentId:n,icon:c})}for(const a in e.recordMap.block)if("page"===e.recordMap.block[a].value.type){const o=e.recordMap.block[a].value?.properties?.title[0][0],r=e.recordMap.block[a].value?.id,n=e.recordMap.block[a].value?.format?.page_icon||null;chrome.storage.local.set({spaceId:e.recordMap.block[a].value?.space_id}),s.spaceId=e.recordMap.block[a].value?.space_id,o&&r&&t.push({id:r,name:o,type:"block",parentId:r,icon:n})}s.databases=a,s.pages=t,chrome.storage.local.get("selectedDB",(e=>{e.selectedDB?(chrome.storage.local.set({databases:a,pages:t,userId:s.userId,userEmail:s.userEmail,userImage:s.userImage,userName:s.userName,selectedDB:e.selectedDB}),chrome.tabs.sendMessage(s.myTabId,{message:"get_user_content",payload:{databases:a,pages:t,userEmail:s.userEmail,userImage:s.userImage,userName:s.userName,userId:s.userId,spaceId:s.spaceId,selectedDB:e.selectedDB}})):(chrome.storage.local.set({databases:a,pages:t,userId:s.userId,userEmail:s.userEmail,userImage:s.userImage,userName:s.userName,selectedDB:a[0]||t[0]}),chrome.tabs.sendMessage(s.myTabId,{message:"get_user_content",payload:{databases:a,pages:t,userEmail:s.userEmail,userImage:s.userImage,userName:s.userName,userId:s.userId,spaceId:s.spaceId,selectedDB:a[0]||t[0]}}))}))}(e)}))}(e)}else chrome.storage.local.set({selectedDB:null})})):"is_show_button_on_hover"===t.message?chrome.cookies.getAll({domain:"www.prototion.com"},(function(e){e.reduce(((e,a)=>({...e,[a.name]:a.value})),{}).user?chrome.cookies.getAll({url:"https://www.notion.so/"},(function(e){e.reduce(((e,a)=>({...e,[a.name]:a.value})),{}).token_v2?chrome.storage.local.get("toggleSaveImage",(e=>{e.toggleSaveImage?chrome.tabs.sendMessage(s.myTabId,{message:"showButtonOnHover"}):chrome.tabs.sendMessage(s.myTabId,{message:"removeButtonOnHover"})})):chrome.tabs.sendMessage(s.myTabId,{message:"removeButtonOnHover"})})):chrome.tabs.sendMessage(s.myTabId,{message:"removeButtonOnHover"})})):"save-url-request"===t.message?chrome.storage.local.get("selectedDB",(a=>{const o=a.selectedDB,r={parentId:o.id,type:o.type,name:t.payload.title,url:t.payload.url,userId:s.userId,content:t.payload.content};e(s.cookies,r).then((e=>{e.success&&n({message:"save_url_success"})})).catch((e=>{n({message:"save_url_failure"})}))})):"save-section-request"===t.message?chrome.storage.local.get("selectedDB",(a=>{const o=a.selectedDB,r={parentId:o.id,type:o.type,name:t.payload.title,url:t.payload.url,userId:s.userId,content:t.payload.content};e(s.cookies,r).then((e=>{e.success&&n({message:"save_section_success"})})).catch((e=>{n({message:"save_section_failure"})}))})):"uploaded-save-image-request"===t.message?chrome.storage.local.get("selectedDB",(a=>{const o=a.selectedDB,r={parentId:o.id,type:o.type,name:t.payload.title,url:t.payload.url,userId:s.userId,content:t.payload.content};e(s.cookies,r).then((e=>{e.success&&n({message:"save_image_success"})})).catch((e=>{n({message:"save_image_failure"})}))})):"save-fullpage-bookmark-request"===t.message?chrome.storage.local.get("selectedDB",(e=>{const o=e.selectedDB,r={content:{blockId:o.parentId,from:"chrome",items:[{url:t.payload.url,title:t.payload.title}],type:"block"},type:o.type};a(s.cookies,r).then((e=>{e.success&&n({message:"save_fullpage_success"})})).catch((e=>{n({message:"save_fullpage_failure"})}))})):"save-image-request"===t.message?chrome.storage.local.get("selectedDB",(e=>{const a=e.selectedDB,r={parentId:a.id,type:a.type,name:t.payload.title,url:t.payload.url,userId:s.userId,imageSrc:t.payload.imageSrc};o(s.cookies,r).then((e=>{e.success&&n({message:"save_image_success"})})).catch((e=>{n({message:"save_image_failure"})}))})):"get_pages"===t.message&&fetch("https://www.notion.so/api/v3/searchWebClipperPages",{method:"POST",headers:{Cookie:s.cookies,"Content-Type":"application/json"},body:JSON.stringify({limit:20,query:t.payload.query,spaceId:s.spaceId})}).then((e=>e.json())).then((e=>n(e.results))).catch((()=>n([]))),!0))),chrome.contextMenus.onClicked.addListener((function(e,a){"notionprototion"===e.menuItemId&&function(e,a){var t=e.pageUrl;"image"==e.mediaType&&(t=e.srcUrl);chrome.tabs.sendMessage(s.myTabId,{message:"sendImgUrl",payload:{data:{imageUrl:t,heading:"Image Preview"}}})}(e)}))}catch(e){console.log(e)}})()})();